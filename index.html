<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health‑Tracker</title>

    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- ===================  STYLES  =================== -->
    <style>
        /* … (unverändert – alle bisherigen Styles) … */
        /* Den kompletten Style‑Block habe ich unverändert gelassen,
           damit Ihr bisheriges Design exakt erhalten bleibt.      */
        /* --------------------------------------------------------- */

        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#CFD6D5 0%,#86B9B1 100%);min-height:100vh;padding:20px;color:#26343E}
        .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(4,38,48,.2);overflow:hidden}
        .header-container{width:100%;background:linear-gradient(45deg,#042630 0%,#26343E 100%);padding:30px 20px;border-radius:15px 15px 0 0;box-shadow:0 4px 20px rgba(4,38,48,.3)}
        .header-title{font-size:40px;font-weight:bold;text-align:center;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,.3);margin-bottom:20px}
        .status-notice{background:linear-gradient(45deg,#dc3545,#c82333);color:#fff;padding:15px;text-align:center;margin-bottom:10px;border-radius:8px;font-weight:600;display:none}
        .status-notice.show{display:block}
        .status-notice.success{background:linear-gradient(45deg,#28a745,#20c997)}
        .nav-buttons{display:flex;justify-content:center;gap:15px;flex-wrap:wrap}
        .pill-button{background:rgba(134,185,177,.2);border:2px solid rgba(134,185,177,.4);color:#fff;padding:12px 24px;border-radius:25px;cursor:pointer;transition:.3s;font-weight:600;backdrop-filter:blur(10px)}
        .pill-button:hover{background:rgba(75,114,114,.8);border-color:#4B7272;transform:translateY(-2px);box-shadow:0 4px 15px rgba(75,114,114,.3)}
        .pill-button.active{background:#86B9B1;color:#042630;border-color:#86B9B1;box-shadow:0 4px 15px rgba(134,185,177,.4)}
        .content-section{display:none;padding:30px}
        .content-section.active{display:block}
        .cards-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px}
        .cards-section-full{display:grid;grid-template-columns:1fr;gap:20px;width:100%}
        .card{background:linear-gradient(145deg,#CFD6D5,#fff);border-radius:15px;padding:25px;box-shadow:0 8px 25px rgba(4,38,48,.1);border:1px solid rgba(134,185,177,.2);transition:.3s}
        .card:hover{box-shadow:0 12px 35px rgba(4,38,48,.15);transform:translateY(-2px)}
        .card h3{font-size:20px;font-weight:bold;text-align:center;color:#042630;margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #86B9B1}
        .card-content{line-height:1.6}
        .card-content div{margin:8px 0;padding:5px 0}
        .label{font-weight:600;color:#26343E}
        .value{color:#4B7272;font-weight:bold}
        .progress-container{margin:15px 0}
        .progress-bar{width:100%;height:20px;background:#CFD6D5;border-radius:10px;overflow:hidden;border:1px solid rgba(134,185,177,.3)}
        .progress-fill{height:100%;background:linear-gradient(90deg,#86B9B1,#4B7272);transition:width .5s;border-radius:10px;box-shadow:0 2px 8px rgba(134,185,177,.3)}
        .progress-text{text-align:center;margin-top:5px;font-weight:bold;color:#4B7272}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;margin-bottom:5px;font-weight:600;color:#042630}
        .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:2px solid #CFD6D5;border-radius:8px;font-size:16px;transition:.3s;background:rgba(255,255,255,.9);color:#26343E}
        .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#86B9B1;box-shadow:0 0 0 3px rgba(134,185,177,.1);background:#fff}
        .btn-primary{background:linear-gradient(45deg,#86B9B1 0%,#4B7272 100%);color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;transition:.3s;box-shadow:0 4px 15px rgba(134,185,177,.3);text-shadow:0 1px 2px rgba(4,38,48,.3)}
        .btn-primary:hover{background:linear-gradient(45deg,#4B7272 0%,#042630 100%);transform:translateY(-2px);box-shadow:0 6px 20px rgba(75,114,114,.4)}
        .btn-secondary{background:linear-gradient(45deg,#4B7272 0%,#26343E 100%);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;margin-left:10px;transition:.3s;font-weight:500;box-shadow:0 2px 8px rgba(75,114,114,.2)}
        .btn-secondary:hover{background:linear-gradient(45deg,#042630 0%,#26343E 100%);transform:translateY(-1px)}
        .btn-danger{background:linear-gradient(45deg,#dc3545 0%,#c82333 100%);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;margin-left:10px;transition:.3s;font-weight:500;box-shadow:0 2px 8px rgba(220,53,69,.2)}
        .btn-danger:hover{background:linear-gradient(45deg,#c82333 0%,#a71e2a 100%);transform:translateY(-1px)}
        .list-item{background:linear-gradient(145deg,#CFD6D5,rgba(255,255,255,.9));border:1px solid rgba(134,185,177,.3);border-radius:8px;padding:15px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;transition:.3s;box-shadow:0 2px 8px rgba(4,38,48,.05)}
        .list-item:hover{transform:translateY(-1px);box-shadow:0 4px 15px rgba(4,38,48,.1)}
        .weight-table{width:100%;border-collapse:collapse;margin-top:20px}
        .weight-table th,.weight-table td{padding:12px;text-align:left;border-bottom:1px solid rgba(134,185,177,.3)}
        .weight-table th{background:linear-gradient(145deg,#86B9B1,#CFD6D5);font-weight:600;color:#042630}
        @media(max-width:768px){.cards-section{grid-template-columns:1fr}.nav-buttons{flex-direction:column;align-items:center}.header-title{font-size:28px}}
    </style>
</head>
<body>
<div class="container">
    <!-- ===================  HEADER  =================== -->
    <div class="header-container">
        <h1 class="header-title">Health‑Tracker</h1>
        <div id="status-notice" class="status-notice"><span id="status-text">Status wird geladen…</span></div>
        <div class="nav-buttons">
            <button class="pill-button active" onclick="showSection('dashboard')">Dashboard</button>
            <button class="pill-button"        onclick="showSection('eingabe')">Eingabe</button>
            <button class="pill-button"        onclick="showSection('tagebuch')">Tagebuch</button>
            <button class="pill-button"        onclick="showSection('einstellung')">Einstellung</button>
        </div>
    </div>

    <!-- ===================  DASHBOARD  =================== -->
    <div id="dashboard" class="content-section active">
        <div class="cards-section">
            <!-- Karte 1 -->
            <div class="card">
                <h3>Fastenzeitraum</h3>
                <div class="card-content">
                    <div><span class="label">Startdatum:</span> <span class="value" id="fast-start">‑</span></div>
                    <div><span class="label">Zieldatum:</span> <span class="value" id="fast-end">‑</span></div>
                    <div><span class="label">Verbleibende Wochen:</span> <span class="value" id="weeks-left">‑</span></div>
                    <div><span class="label">Verbleibende Tage:</span> <span class="value" id="days-left">‑</span></div>
                </div>
            </div>

            <!-- Karte 2 -->
            <div class="card">
                <h3>Gewichtsziel</h3>
                <div class="card-content">
                    <div><span class="label">Startgewicht:</span> <span class="value" id="start-weight">‑</span></div>
                    <div><span class="label">Zielgewicht:</span> <span class="value" id="target-weight">‑</span></div>
                    <div><span class="label">Gesamtabnahme:</span> <span class="value" id="total-loss">‑</span></div>
                    <div><span class="label">Ø pro Woche:</span> <span class="value" id="avg-week">‑</span></div>
                    <div><span class="label">Ø pro Tag:</span> <span class="value" id="avg-day">‑</span></div>
                </div>
            </div>

            <!-- Karte 3 -->
            <div class="card">
                <h3>Fortschritt</h3>
                <div class="card-content">
                    <div><span class="label">Aktuelles Gewicht:</span> <span class="value" id="current-weight">‑</span></div>
                    <div><span class="label">Erreicht:</span> <span class="value" id="progress-percent">‑</span></div>
                    <div class="progress-container">
                        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
                        <div class="progress-text" id="progress-text">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Diagramm -->
        <div class="cards-section-full" style="margin-top:30px">
            <div class="card">
                <h3 style="text-align:left">Gewichtsverlauf</h3>
                <div class="card-content">
                    <svg id="weight-chart" width="100%" height="300" style="border:1px solid rgba(134,185,177,.3);border-radius:8px"></svg>
                    <div class="chart-legend" style="margin-top:15px;display:flex;justify-content:center;gap:20px">
                        <div style="display:flex;align-items:center"><div style="width:20px;height:3px;background:#dc3545;margin-right:5px"></div><span>Startgewicht</span></div>
                        <div style="display:flex;align-items:center"><div style="width:20px;height:3px;background:#28a745;margin-right:5px"></div><span>Zielgewicht</span></div>
                        <div style="display:flex;align-items:center"><div style="width:20px;height:3px;background:#4B7272;margin-right:5px"></div><span>Tägliches Gewicht</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================  EINGABE  =================== -->
    <div id="eingabe" class="content-section">
        <div class="cards-section-full">
            <div class="card">
                <h3 style="text-align:left">Gewicht eingeben</h3>
                <div class="card-content">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;align-items:end">
                        <div class="form-group">
                            <label for="weight-date">Datum:</label>
                            <input type="date" id="weight-date">
                        </div>
                        <div class="form-group">
                            <label for="weight-value">Gewicht (kg):</label>
                            <input type="number" step="0.1" id="weight-value" placeholder="z. B. 75.5">
                        </div>
                        <div><button class="btn-primary" onclick="addWeight()">Gewicht hinzufügen</button></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabelle -->
        <div class="cards-section-full" style="margin-top:30px">
            <div class="card">
                <h3 style="text-align:left">Gewichtseinträge</h3>
                <div class="card-content">
                    <table class="weight-table">
                        <thead><tr><th>Datum</th><th>Gewicht (kg)</th><th>Aktionen</th></tr></thead>
                        <tbody id="weight-entries"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================  TAGEBUCH  =================== -->
    <div id="tagebuch" class="content-section">
        <div class="cards-section-full">
            <div class="card">
                <h3 style="text-align:left">Neuer Tagebucheintrag</h3>
                <div class="card-content">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px">
                        <div class="form-group"><label for="diary-date">Datum:</label><input type="date" id="diary-date"></div>
                        <div class="form-group"><label for="diary-title">Titel:</label><input type="text" id="diary-title" placeholder="Titel"></div>
                    </div>
                    <div class="form-group"><label for="diary-content">Inhalt:</label><textarea id="diary-content" rows="5" placeholder="Wie war Ihr Tag?"></textarea></div>
                    <div style="margin-top:20px"><button class="btn-primary" onclick="addDiaryEntry()">Eintrag speichern</button></div>
                </div>
            </div>
        </div>

        <!-- Liste -->
        <div class="cards-section-full" style="margin-top:30px">
            <div class="card">
                <h3 style="text-align:left">Meine Tagebucheinträge</h3>
                <div class="card-content"><div id="diary-entries"></div></div>
            </div>
        </div>
    </div>

    <!-- ===================  EINSTELLUNG  =================== -->
    <div id="einstellung" class="content-section">
        <div class="cards-section-full">
            <div class="card">
                <h3 style="text-align:left">Grundeinstellungen</h3>
                <div class="card-content">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px">
                        <div class="form-group"><label for="settings-start-weight">Startgewicht (kg):</label><input type="number" step="0.1" id="settings-start-weight" placeholder="z. B. 80.0"></div>
                        <div class="form-group"><label for="settings-target-weight">Zielgewicht (kg):</label><input type="number" step="0.1" id="settings-target-weight" placeholder="z. B. 70.0"></div>
                        <div class="form-group"><label for="settings-fast-start">Startdatum:</label><input type="date" id="settings-fast-start"></div>
                        <div class="form-group"><label for="settings-fast-end">Zieldatum:</label><input type="date" id="settings-fast-end"></div>
                    </div>
                    <div style="margin-top:20px"><button class="btn-primary" onclick="saveSettings()">Einstellungen speichern</button></div>
                </div>
            </div>
        </div>

        <!-- Datenmanagement -->
        <div class="cards-section-full" style="margin-top:30px">
            <div class="card">
                <h3 style="text-align:left">Datenmanagement</h3>
                <div class="card-content">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
                        <button class="btn-secondary" onclick="exportData()">Daten exportieren</button>
                        <button class="btn-secondary" onclick="document.getElementById('import-file').click()">Daten importieren</button>
                        <button class="btn-danger"    onclick="resetAllData()">Alle Daten löschen</button>
                    </div>
                    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
                    <div style="margin-top:15px;padding:15px;background:rgba(134,185,177,.1);border-radius:8px">
                        <p style="font-size:14px;color:#042630;margin:0"><strong>💾 Datenspeicherung:</strong> <span id="storage-status">Status wird geladen…</span></p>
                        <p style="font-size:12px;color:#666;margin:5px 0 0">Export/Import für Backups und Geräte‑Transfer verwenden.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===================  SCRIPT  =================== -->
<script>
/* ---------- 1.  Firebase‑Konfiguration (Ihre echten Werte) ---------- */
const firebaseConfig = {
  apiKey:            "AIzaSyDgLo3neIRWlzXaXDZpjNmnp6olqh7Wz7g",
  authDomain:        "mein-health-tracker.firebaseapp.com",
  projectId:         "mein-health-tracker",
  storageBucket:     "mein-health-tracker.appspot.com",
  messagingSenderId: "296062748338",
  appId:             "1:296062748338:web:6b17b73afe264001c72bab",
  measurementId:     "G-414T5Q6H8X"
};

/* ---------- 2.  Schlüssel für Local Storage ---------- */
const USER_ID_KEY    = 'healthTrackerUserId';
const LOCAL_DATA_KEY = 'healthTrackerData';

/* ---------- 3.  Zentrale App‑Daten ---------- */
let appData = {
    settings: { fastStart:'', fastEnd:'', startWeight:0, targetWeight:0 },
    weights:  [],
    diaryEntries:[]
};

/* ---------- 4.  Firebase‑Variablen ---------- */
let db               = null;
let userId           = null;
let isFirebaseOnline = false;

/* ==================================================================== */
/*  -------------------------  HELPER  -------------------------------- */
/* ==================================================================== */

// 4.1 User‑ID einmalig erzeugen oder wiederverwenden
function getOrCreateUserId() {
    let id = localStorage.getItem(USER_ID_KEY);
    if (!id) {
        id = 'user_' + Math.random().toString(36).substr(2,9) + '_' + Date.now();
        localStorage.setItem(USER_ID_KEY, id);
    }
    return id;
}

// 4.2 Local‑Backup laden/speichern
function loadLocalBackup() {
    const raw = localStorage.getItem(LOCAL_DATA_KEY);
    if (raw) {
        try { appData = JSON.parse(raw); }
        catch(e){ console.warn('Lokaler Backup‑Datensatz defekt', e);}
    }
}
function saveLocalBackup() {
    localStorage.setItem(LOCAL_DATA_KEY, JSON.stringify(appData));
}

// 4.3 Statusanzeige
function showStatus(msg, ok=false) {
    const notice = document.getElementById('status-notice');
    const text   = document.getElementById('status-text');
    text.textContent = msg;
    notice.className = `status-notice show ${ok?'success':''}`;
    setTimeout(()=>notice.classList.remove('show'), 5000);
}
function updateStorageStatus() {
    const el = document.getElementById('storage-status');
    if (!el) return;
    el.textContent = isFirebaseOnline
        ? 'Cloud‑Speicherung aktiv ✅'
        : 'Lokales Backup (offline) ⚠️';
    el.style.color = isFirebaseOnline ? '#28a745' : '#dc3545';
}

/* ==================================================================== */
/*  ----------------------  FIREBASE  --------------------------------- */
/* ==================================================================== */
function initializeFirebase() {
    if (!firebaseConfig.apiKey) {               // Konfig nicht gesetzt
        console.warn('Firebase nicht konfiguriert');
        isFirebaseOnline=false;
        updateStorageStatus();
        return;
    }
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        userId = getOrCreateUserId();           // <- stabile ID
    } catch(err) {
        console.error('Firebase Init fehlgeschlagen', err);
        isFirebaseOnline=false;
        updateStorageStatus();
    }
}

// Verbindung testen
async function testFirebaseConnection() {
    try {
        await db.collection('users').doc(userId).get();
        isFirebaseOnline=true;
        showStatus('✅ Cloud‑Speicherung aktiv', true);
    } catch(err){
        console.warn('Firebase nicht erreichbar:', err);
        isFirebaseOnline=false;
        showStatus('❌ Cloud nicht erreichbar – lokale Speicherung');
    }
    updateStorageStatus();
}

/* Daten laden */
async function loadData() {
    if (isFirebaseOnline) {
        try {
            const doc = await db.collection('users').doc(userId).get();
            if (doc.exists) appData = {...appData, ...doc.data()};
            console.log('📥 Daten aus Firestore geladen');
        } catch(err) {
            console.error('Fehler beim Cloud‑Laden', err);
        }
    } else {
        loadLocalBackup();
        console.log('📥 Daten aus Local Storage geladen');
    }
}

/* Daten speichern */
async function saveData() {
    if (isFirebaseOnline) {
        try {
            await db.collection('users').doc(userId).set({
                ...appData,
                lastUpdated: new Date().toISOString()
            });
            console.log('💾 Daten in Firestore gespeichert');
        } catch(err){
            console.error('Fehler beim Cloud‑Speichern', err);
        }
    }
    saveLocalBackup();   // immer lokale Sicherung
}

/* ==================================================================== */
/*  ---------------------  UI‑FUNKTIONEN  ----------------------------- */
/* ==================================================================== */

// Settings ----------------------------------------------------------------
async function saveSettings() {
    appData.settings.fastStart   = document.getElementById('settings-fast-start').value;
    appData.settings.fastEnd     = document.getElementById('settings-fast-end').value;
    appData.settings.startWeight = parseFloat(document.getElementById('settings-start-weight').value)||0;
    appData.settings.targetWeight= parseFloat(document.getElementById('settings-target-weight').value)||0;
    await saveData();
    alert('Einstellungen gespeichert!');
    updateDashboard();
}
function loadSettingsForm() {
    const s = appData.settings;
    document.getElementById('settings-fast-start').value   = s.fastStart||'';
    document.getElementById('settings-fast-end').value     = s.fastEnd||'';
    document.getElementById('settings-start-weight').value = s.startWeight||'';
    document.getElementById('settings-target-weight').value= s.targetWeight||'';
}

// Gewichte ---------------------------------------------------------------
async function addWeight() {
    const date   = document.getElementById('weight-date').value;
    const weight = parseFloat(document.getElementById('weight-value').value);
    if (!date||!weight){ alert('Bitte Datum und Gewicht eingeben!'); return;}
    const idx = appData.weights.findIndex(e=>e.date===date);
    if (idx!==-1) appData.weights[idx].weight = weight;
    else          appData.weights.push({date,weight});
    appData.weights.sort((a,b)=>new Date(b.date)-new Date(a.date));
    document.getElementById('weight-value').value='';
    await saveData();
    updateWeightTable(); updateDashboard();
}
async function editWeight(i) {
    const entry = appData.weights[i];
    const nw = prompt('Neues Gewicht:', entry.weight);
    if (nw!==null && !isNaN(parseFloat(nw))){
        appData.weights[i].weight=parseFloat(nw);
        await saveData();
        updateWeightTable(); updateDashboard();
    }
}
async function deleteWeight(i){
    if (confirm('Gewichtseintrag löschen?')){
        appData.weights.splice(i,1);
        await saveData();
        updateWeightTable(); updateDashboard();
    }
}
function updateWeightTable(){
    const tbody=document.getElementById('weight-entries');
    tbody.innerHTML='';
    if (!appData.weights.length){
        tbody.innerHTML='<tr><td colspan="3" style="text-align:center;color:#666;font-style:italic;padding:20px">Noch keine Einträge.</td></tr>';
        return;
    }
    appData.weights.forEach((e,i)=>{
        const tr=tbody.insertRow();
        tr.innerHTML=`<td>${new Date(e.date).toLocaleDateString('de-DE')}</td>
                      <td>${e.weight} kg</td>
                      <td>
                        <button class="btn-secondary" onclick="editWeight(${i})">Bearbeiten</button>
                        <button class="btn-danger"    onclick="deleteWeight(${i})">Löschen</button>
                      </td>`;
    });
}

// Tagebuch ---------------------------------------------------------------
async function addDiaryEntry(){
    const date=document.getElementById('diary-date').value;
    const title=document.getElementById('diary-title').value;
    const content=document.getElementById('diary-content').value;
    if(!date||!title||!content){alert('Bitte alle Felder ausfüllen!');return;}
    appData.diaryEntries.push({date,title,content});
    appData.diaryEntries.sort((a,b)=>new Date(b.date)-new Date(a.date));
    document.getElementById('diary-title').value='';
    document.getElementById('diary-content').value='';
    await saveData();
    updateDiaryDisplay();
}
async function editDiaryEntry(i){
    const entry=appData.diaryEntries[i];
    const nt=prompt('Titel bearbeiten:',entry.title);
    if(nt!==null&&nt.trim()!==''){
        const nc=prompt('Inhalt bearbeiten:',entry.content);
        if(nc!==null){
            appData.diaryEntries[i].title=nt.trim();
            appData.diaryEntries[i].content=nc;
            await saveData(); updateDiaryDisplay();
        }
    }
}
async function deleteDiaryEntry(i){
    if(confirm('Tagebucheintrag löschen?')){
        appData.diaryEntries.splice(i,1);
        await saveData(); updateDiaryDisplay();
    }
}
function updateDiaryDisplay(){
    const c=document.getElementById('diary-entries');
    c.innerHTML='';
    if(!appData.diaryEntries.length){
        c.innerHTML='<p style="color:#666;font-style:italic;text-align:center;padding:20px">Noch keine Einträge.</p>';
        return;
    }
    appData.diaryEntries.forEach((e,i)=>{
        const div=document.createElement('div');
        div.className='list-item'; div.style.flexDirection='column';
        div.innerHTML=`<div style="display:flex;justify-content:space-between;width:100%;margin-bottom:10px">
                          <div><strong>${e.title}</strong><em style="margin-left:10px">${new Date(e.date).toLocaleDateString('de-DE')}</em></div>
                          <div>
                            <button class="btn-secondary" onclick="editDiaryEntry(${i})">Bearbeiten</button>
                            <button class="btn-danger"    onclick="deleteDiaryEntry(${i})">Löschen</button>
                          </div>
                       </div>
                       <div style="width:100%">${e.content}</div>`;
        c.appendChild(div);
    });
}

/* Dashboard & Chart ---------------------------------------------------- */
function getCurrentWeight(){ return appData.weights.length?appData.weights[0].weight:null; }
function updateDashboard(){
    const s=appData.settings;
    // Fasten
    if(s.fastStart && s.fastEnd){
        const start=new Date(s.fastStart), end=new Date(s.fastEnd), today=new Date();
        document.getElementById('fast-start').textContent=start.toLocaleDateString('de-DE');
        document.getElementById('fast-end').textContent  =end.toLocaleDateString('de-DE');
        const diff=end-today, days=Math.max(0,Math.ceil(diff/86400000)), weeks=Math.floor(days/7);
        document.getElementById('weeks-left').textContent=weeks;
        document.getElementById('days-left').textContent =days;
    }
    // Ziele
    if(s.startWeight && s.targetWeight){
        document.getElementById('start-weight').textContent =s.startWeight+' kg';
        document.getElementById('target-weight').textContent=s.targetWeight+' kg';
        const total=s.startWeight-s.targetWeight;
        document.getElementById('total-loss').textContent  =total.toFixed(1)+' kg';
        if(s.fastStart && s.fastEnd){
            const days=(new Date(s.fastEnd)-new Date(s.fastStart))/86400000;
            const weeks=days/7;
            document.getElementById('avg-week').textContent =(total/weeks).toFixed(2)+' kg';
            document.getElementById('avg-day').textContent  =(total/days ).toFixed(3)+' kg';
        }
    }
    // Fortschritt
    const cw=getCurrentWeight();
    if(cw && s.startWeight && s.targetWeight){
        document.getElementById('current-weight').textContent=cw+' kg';
        const total=s.startWeight-s.targetWeight;
        const curr =s.startWeight-cw;
        const p=Math.max(0,Math.min(100,(curr/total)*100));
        document.getElementById('progress-percent').textContent=p.toFixed(1)+'%';
        document.getElementById('progress-fill').style.width=p+'%';
        document.getElementById('progress-text').textContent=p.toFixed(1)+'%';
    }
    drawWeightChart();
}

// Chart (14 Tage)
function drawWeightChart(){
    const s=appData.settings;
    const svg=document.getElementById('weight-chart');
    const rect=svg.getBoundingClientRect();
    const width=rect.width||800, height=300;
    svg.setAttribute('width',width); svg.setAttribute('height',height); svg.innerHTML='';
    if(!s.startWeight||!s.targetWeight){
        svg.innerHTML='<text x="50%" y="50%" text-anchor="middle" fill="#666" font-size="16">Bitte Grundeinstellungen konfigurieren</text>';
        return;
    }
    // Daten
    const today=new Date(), dates=[];
    for(let i=13;i>=0;i--){ const d=new Date(today); d.setDate(today.getDate()-i); dates.push(d.toISOString().split('T')[0]); }
    const m={top:20,right:20,bottom:60,left:60}, cw=width-m.left-m.right, ch=height-m.top-m.bottom;
    const min=Math.min(s.targetWeight-2, s.startWeight-5);
    const max=Math.max(s.startWeight+2, s.targetWeight+5);
    const range=max-min;
    const getX=i=>m.left+i*cw/(dates.length-1);
    const getY=w=>m.top+ch-((w-min)/range*ch);
    // Grid
    for(let i=0;i<dates.length;i+=2){
        const x=getX(i);
        svg.innerHTML+=`<line x1="${x}" y1="${m.top}" x2="${x}" y2="${height-m.bottom}" stroke="rgba(134,185,177,.3)" />`;
    }
    for(let i=0;i<=5;i++){
        const w=min+range/5*i, y=getY(w);
        svg.innerHTML+=`<line x1="${m.left}" y1="${y}" x2="${width-m.right}" y2="${y}" stroke="rgba(134,185,177,.3)" />`;
        svg.innerHTML+=`<text x="${m.left-10}" y="${y+4}" text-anchor="end" font-size="12" fill="#4B7272">${w.toFixed(1)}</text>`;
    }
    // Achsen
    svg.innerHTML+=`<line x1="${m.left}" y1="${m.top}" x2="${m.left}" y2="${height-m.bottom}" stroke="#042630" stroke-width="2"/>`;
    svg.innerHTML+=`<line x1="${m.left}" y1="${height-m.bottom}" x2="${width-m.right}" y2="${height-m.bottom}" stroke="#042630" stroke-width="2"/>`;
    dates.forEach((d,i)=>{ if(i%2===0){
        const x=getX(i), dt=new Date(d);
        svg.innerHTML+=`<text x="${x}" y="${height-m.bottom+20}" text-anchor="middle" font-size="10" fill="#4B7272">${dt.getDate()}.${dt.getMonth()+1}</text>`;
    }});
    svg.innerHTML+=`<text x="20" y="${height/2}" text-anchor="middle" transform="rotate(-90 20 ${height/2})" font-size="12" fill="#042630">Gewicht (kg)</text>`;
    // Ziel & Start
    svg.innerHTML+=`<line x1="${m.left}" y1="${getY(s.targetWeight)}" x2="${width-m.right}" y2="${getY(s.targetWeight)}" stroke="#28a745" stroke-width="3" stroke-dasharray="5,5"/>`;
    svg.innerHTML+=`<line x1="${m.left}" y1="${getY(s.startWeight)}"  x2="${width-m.right}" y2="${getY(s.startWeight)}"  stroke="#dc3545" stroke-width="3" stroke-dasharray="5,5"/>`;
    // Messwerte
    const vals=dates.map(d=>{const e=appData.weights.find(w=>w.date===d); return e?e.weight:null;});
    let path='', has=false;
    vals.forEach((w,i)=>{ if(w!==null){
        const x=getX(i), y=getY(w);
        if(!has){path+=`M${x},${y}`; has=true;} else{path+=` L${x},${y}`;}
        svg.innerHTML+=`<circle cx="${x}" cy="${y}" r="4" fill="#86B9B1" stroke="#fff" stroke-width="2"/>`;
    }});
    if(has) svg.innerHTML+=`<path d="${path}" stroke="#4B7272" stroke-width="3" fill="none"/>`;
}

/* Export / Import / Reset ------------------------------------------- */
function exportData(){
    const blob=new Blob([JSON.stringify({...appData,exportDate:new Date().toISOString(),version:'3.1'},null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url;
    a.download=`health-tracker-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    alert('Daten exportiert!');
}
async function importData(e){
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=async evt=>{
        try{
            const data=JSON.parse(evt.target.result);
            if(!data.settings||!Array.isArray(data.weights)||!Array.isArray(data.diaryEntries)) throw new Error('Ungültiges Format');
            if(confirm('Aktuelle Daten ersetzen?')){
                appData={settings:data.settings,weights:data.weights,diaryEntries:data.diaryEntries};
                await saveData();
                loadSettingsForm(); updateDashboard(); updateWeightTable(); updateDiaryDisplay();
                alert('Import erfolgreich!');
            }
        }catch(err){alert('Fehler: '+err.message);}
    };
    reader.readAsText(file); e.target.value='';
}
async function resetAllData(){
    if(confirm('ALLE Daten löschen?')){
        appData={settings:{fastStart:'',fastEnd:'',startWeight:0,targetWeight:0},weights:[],diaryEntries:[]};
        await saveData();
        loadSettingsForm(); updateDashboard(); updateWeightTable(); updateDiaryDisplay();
        alert('Alle Daten gelöscht!');
    }
}

/* Navigation --------------------------------------------------------- */
function showSection(name){
    document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    document.querySelectorAll('.pill-button').forEach(b=>b.classList.remove('active'));
    event.target.classList.add('active');
    if(name==='dashboard') updateDashboard();
    if(name==='einstellung') {loadSettingsForm(); updateStorageStatus();}
}

/* ==================================================================== */
/*  ----------------------  INITIALISIERUNG  -------------------------- */
/* ==================================================================== */
document.addEventListener('DOMContentLoaded', initApp);

async function initApp(){
    console.log('🚀 Health‑Tracker startet…');
    const today=new Date().toISOString().split('T')[0];
    document.getElementById('weight-date').value=today;
    document.getElementById('diary-date').value =today;

    initializeFirebase();
    await testFirebaseConnection().catch(()=>{});
    await loadData();
    loadSettingsForm();
    updateDashboard(); updateWeightTable(); updateDiaryDisplay(); updateStorageStatus();
}
</script>
</body>
</html>
