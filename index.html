<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Einfacher Gewichts-Tracker</title>

<!-- Mini-Design -->
<style>
  :root{--bg:#f3f4f6;--card:#fff;--accent:#2563eb}
  *{box-sizing:border-box;font-family:system-ui,Arial}
  body{margin:0;background:var(--bg);color:#111}
  header{background:var(--card);padding:1rem;display:flex;gap:.5rem;position:sticky;top:0}
  header button{padding:.5rem 1rem;border:1px solid var(--accent);background:none;border-radius:.5rem;cursor:pointer}
  header button.active{background:var(--accent);color:#fff}
  main{padding:1rem;max-width:900px;margin:auto}
  section{display:none}
  section.active{display:block}
  .card{background:var(--card);padding:1rem;margin-bottom:1rem;border-radius:.75rem;box-shadow:0 1px 4px #0001}
  input,textarea,select{width:100%;padding:.5rem;border:1px solid #ccc;border-radius:.5rem}
  label{font-size:.9rem;margin:.5rem 0 .25rem;display:block}
  .flex{display:flex;gap:.5rem;flex-wrap:wrap}
  .habitBtn{padding:.25rem .75rem;border:1px solid var(--accent);border-radius:.5rem;background:none;cursor:pointer;font-size:.8rem}
  .habitBtn.active{background:var(--accent);color:#fff}
  canvas{max-width:100%}
</style>
<!-- Chart.js für das Gewichtsdiagramm -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <button data-view="dash" class="active">Dashboard</button>
  <button data-view="entry">Eingabe</button>
  <button data-view="settings">Einstellungen</button>
</header>

<main>
  <!-- Dashboard -->
  <section id="dash" class="active">
    <div class="card" id="summary"></div>
    <div class="card"><canvas id="weightChart" height="200"></canvas></div>
    <div class="card" id="habitStats"></div>
    <div class="card" id="diaryList"></div>
  </section>

  <!-- Eingabe -->
  <section id="entry">
    <div class="card">
      <label>Datum
        <input type="date" id="dateInput">
      </label>

      <label>Gewicht (kg)
        <input type="number" step="0.1" id="weightInput">
      </label>

      <label>Gewohnheiten</label>
      <div id="habitChoices" class="flex"></div>

      <label>Tagebuch
        <textarea rows="4" id="diaryInput"></textarea>
      </label>

      <button id="saveEntry" style="margin-top:.5rem;padding:.5rem 1rem;background:var(--accent);color:#fff;border:none;border-radius:.5rem;cursor:pointer">Speichern</button>
    </div>
  </section>

  <!-- Einstellungen -->
  <section id="settings">
    <div class="card">
      <label>Startgewicht (kg)
        <input type="number" step="0.1" id="startWeight">
      </label>
      <label>Zielgewicht (kg)
        <input type="number" step="0.1" id="targetWeight">
      </label>
      <label>Fasten-Start
        <input type="date" id="fastStart">
      </label>
      <label>Fasten-Ende
        <input type="date" id="fastEnd">
      </label>
    </div>

    <div class="card">
      <h3>Gewohnheiten</h3>
      <div id="habitList"></div>
      <div class="flex" style="margin-top:.5rem">
        <input placeholder="Neue Gewohnheit" id="habitName">
        <select id="habitFreq">
          ${[...Array(7)].map((_,i)=>`<option value="${i+1}">${i+1}×/Woche</option>`).join('')}
        </select>
        <button id="addHabit">Hinzufügen</button>
      </div>
    </div>

    <button id="saveSettings" style="padding:.5rem 1rem;background:var(--accent);color:#fff;border:none;border-radius:.5rem;cursor:pointer">Einstellungen speichern</button>
  </section>
</main>

<script>
/*--------------- Datenhaltung ---------------*/
const LS_KEY = 'simpleTracker';
function load(){return JSON.parse(localStorage.getItem(LS_KEY)||'{}')}
function save(data){localStorage.setItem(LS_KEY,JSON.stringify(data))}
let data = load();

/* Default-Struktur */
data.settings ??= {startWeight:0,targetWeight:0,fastStart:null,fastEnd:null,habits:[]};
data.weights  ??= [];   // [{date,kg}]
data.hLogs    ??= [];   // [{date,habitId}]
data.diary    ??= [];   // [{date,text}]
save(data);

/*--------------- Element-Shortcuts ---------------*/
const $ = sel=>document.querySelector(sel);
const $$ = sel=>document.querySelectorAll(sel);

/*--------------- View-Umschaltung ---------------*/
$$('header button').forEach(btn=>{
  btn.onclick=()=>{show(btn.dataset.view)};
});
function show(view){
  $$('header button').forEach(b=>b.classList.toggle('active',b.dataset.view===view));
  $$('main section').forEach(s=>s.classList.toggle('active',s.id===view));
  if(view==='dash') renderDash();
  if(view==='entry') initEntry();
  if(view==='settings') initSettings();
}

/*--------------- Einstellungen ---------------*/
function initSettings(){
  $('#startWeight').value = data.settings.startWeight||'';
  $('#targetWeight').value = data.settings.targetWeight||'';
  $('#fastStart').value    = data.settings.fastStart||'';
  $('#fastEnd').value      = data.settings.fastEnd||'';
  renderHabitList();
}
$('#addHabit').onclick=()=>{
  const name=$('#habitName').value.trim();
  const perWeek=+$('#habitFreq').value;
  if(!name) return;
  data.settings.habits.push({id:Date.now().toString(36),name,perWeek});
  $('#habitName').value='';
  renderHabitList();
};
function renderHabitList(){
  const box=$('#habitList'); box.innerHTML='';
  data.settings.habits.forEach(h=>{
    const div=document.createElement('div');
    div.className='flex'; div.style.cssText='justify-content:space-between;margin:.25rem 0';
    div.innerHTML=`<span>${h.name} (${h.perWeek}×)</span><button data-id="${h.id}">X</button>`;
    box.appendChild(div);
  });
  box.querySelectorAll('button').forEach(b=>{
    b.onclick=()=>{data.settings.habits=data.settings.habits.filter(h=>h.id!==b.dataset.id);renderHabitList();}
  });
}
$('#saveSettings').onclick=()=>{
  Object.assign(data.settings,{
    startWeight:+$('#startWeight').value||0,
    targetWeight:+$('#targetWeight').value||0,
    fastStart:$('#fastStart').value||null,
    fastEnd:$('#fastEnd').value||null
  });
  save(data); alert('Gespeichert'); show('dash');
};

/*--------------- Eingabe ---------------*/
function initEntry(){
  const d=new Date().toISOString().substr(0,10);
  $('#dateInput').value=d;
  $('#weightInput').value='';
  $('#diaryInput').value='';
  renderHabitChoices([]);
}
function renderHabitChoices(selected){
  const box=$('#habitChoices'); box.innerHTML='';
  data.settings.habits.forEach(h=>{
    const btn=document.createElement('button');
    btn.className='habitBtn'+(selected.includes(h.id)?' active':'');
    btn.textContent=h.name;
    btn.onclick=()=>{btn.classList.toggle('active');};
    btn.dataset.id=h.id;
    box.appendChild(btn);
  });
}
$('#dateInput').onchange=e=>{
  const date=e.target.value;
  const w=data.weights.find(w=>w.date===date);
  $('#weightInput').value=w?.kg||'';
  const sel=data.hLogs.filter(l=>l.date===date).map(l=>l.habitId);
  renderHabitChoices(sel);
  const dEntry=data.diary.find(d=>d.date===date);
  $('#diaryInput').value=dEntry?.text||'';
};
$('#saveEntry').onclick=()=>{
  const date=$('#dateInput').value;
  const kg=+$('#weightInput').value;
  if(kg){const idx=data.weights.findIndex(w=>w.date===date);
    idx>=0?data.weights[idx].kg=kg:data.weights.push({date,kg});
  }
  const habitIds=[...$('#habitChoices').querySelectorAll('.active')].map(b=>b.dataset.id);
  data.hLogs = data.hLogs.filter(l=>l.date!==date).concat(habitIds.map(id=>({date,habitId:id})));
  const text=$('#diaryInput').value.trim();
  const dIdx=data.diary.findIndex(d=>d.date===date);
  if(text){dIdx>=0?data.diary[dIdx].text=text:data.diary.push({date,text});}
  else if(dIdx>=0){data.diary.splice(dIdx,1);}
  save(data); alert('Eintrag gespeichert'); show('dash');
};

/*--------------- Dashboard ---------------*/
let chart;
function renderDash(){
  // Zusammenfassung
  const curr=data.weights.sort((a,b)=>a.date.localeCompare(b.date)).at(-1);
  const diff=data.settings.startWeight-curr?.kg||0;
  const total=data.settings.startWeight-data.settings.targetWeight||0;
  const pct=total?((diff/total)*100).toFixed(1):0;
  $('#summary').innerHTML=`
    <h3>Übersicht</h3>
    <p>Startgewicht: <b>${data.settings.startWeight||'–'} kg</b><br>
       Zielgewicht: <b>${data.settings.targetWeight||'–'} kg</b><br>
       Aktuell: <b>${curr?.kg||'–'} kg</b></p>
    <div style="background:#ddd;border-radius:.5rem;overflow:hidden;height:1rem">
      <div style="width:${pct}%;background:var(--accent)"></div>
    </div>
    <small>${pct}% vom Ziel erreicht</small>
  `;
  // Diagramm
  const ctx=document.getElementById('weightChart').getContext('2d');
  chart?.destroy();
  chart=new Chart(ctx,{type:'line',
    data:{labels:data.weights.map(w=>w.date),datasets:[{label:'Gewicht',data:data.weights.map(w=>w.kg),fill:false,borderWidth:2}]},
    options:{plugins:{legend:{display:false}}}
  });
  // Habit-Auswertung
  const weeks=Math.max(1,Math.ceil((Date.now()-new Date(data.settings.fastStart||Date.now()))/604800000));
  const stat=data.settings.habits.map(h=>{
    const done=data.hLogs.filter(l=>l.habitId===h.id).length;
    return `<li>${h.name}: ${done}/${h.perWeek*weeks}</li>`;
  }).join('');
  $('#habitStats').innerHTML='<h3>Gewohnheiten (erledigt / Soll)</h3><ul>'+stat+'</ul>';
  // Tagebuchliste
  $('#diaryList').innerHTML='<h3>Tagebuch (letzte 5)</h3>'+data.diary.slice(-5).reverse().map(d=>`<p><b>${d.date}</b><br>${d.text}</p>`).join('')||'–';
}

/*--------------- Initial laden ---------------*/
show('dash');
</script>
</body>
</html>
