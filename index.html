<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Abnehm‑Dashboard</title>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons & Chart.js -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Utility Klassen */
    .card{background:#fff;padding:1rem;border-radius:1rem;box-shadow:0 2px 6px #0001}
    .cardTitle{font-size:1.125rem;font-weight:600;display:flex;align-items:center;gap:.25rem;margin-bottom:.5rem}
    .btnPrimary{background:#4f46e5;color:#fff;padding:.5rem 1rem;border-radius:.75rem;font-weight:600}
    .btnPrimary:hover{background:#4338ca}
    .btnSecondary{background:#059669;color:#fff;padding:.5rem 1rem;border-radius:.75rem;font-weight:600}
    .btnSecondary:hover{background:#047857}
    .btnDisabled{background:#9ca3af!important;cursor:not-allowed!important}
    .inp{padding:.5rem;border:1px solid #d1d5db;border-radius:.375rem;width:100%}
    .navBtn{padding:.4rem .6rem;border-radius:.75rem;background:#f3f4f6;box-shadow:0 1px 3px #0001}
    .navBtn:hover{background:#e5e7eb}
  </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
<div id="app" class="p-4 space-y-8">
  <!-- SETUP SECTION -->
  <section id="setupSection" class="card max-w-md mx-auto space-y-3">
    <h2 class="cardTitle"><i data-lucide="settings"></i> Grundeinstellungen</h2>
    <input id="setupStart" type="date" class="inp" placeholder="Startdatum" />
    <input id="setupEnd" type="date" class="inp" placeholder="Enddatum" />
    <input id="setupStartWeight" type="number" step="0.1" class="inp" placeholder="Startgewicht (kg)" />
    <input id="setupGoalWeight" type="number" step="0.1" class="inp" placeholder="Zielgewicht (kg)" />
    <label class="block text-sm font-medium">Erster Tag der Woche</label>
    <select id="setupWeekStart" class="inp">
      <option value="1" selected>Montag</option><option value="0">Sonntag</option><option value="2">Dienstag</option><option value="3">Mittwoch</option><option value="4">Donnerstag</option><option value="5">Freitag</option><option value="6">Samstag</option>
    </select>
    <button id="setupBtn" class="btnPrimary w-full">Speichern & Loslegen</button>
  </section>

  <!-- MAIN NAV -->
  <nav id="mainNav" class="hidden sticky top-0 z-40 flex justify-between items-center bg-white/70 backdrop-blur rounded-xl shadow px-4 py-2">
    <div class="flex gap-2 items-center">
      <button class="navBtn" data-sec="dashboard"><i data-lucide="home"></i></button>
      <button class="navBtn" data-sec="daily"><i data-lucide="calendar"></i></button>
      <button class="navBtn" data-sec="summary"><i data-lucide="bar-chart-3"></i></button>
    </div>
    <div class="flex items-center gap-2">
      <label for="entryDate" class="text-sm hidden sm:block">Datum:</label>
      <input id="entryDate" type="date" class="inp w-36" />
      <button id="openSettings" class="navBtn ml-2"><i data-lucide="settings"></i></button>
    </div>
  </nav>

  <!-- SETTINGS PANEL -->
  <section id="settingsPanel" class="hidden card max-w-sm mx-auto space-y-3">
    <h3 class="cardTitle"><i data-lucide="sliders"></i> Einstellungen</h3>
    <label class="block text-sm font-medium">Erster Tag der Woche:</label>
    <select id="weekStartSelect" class="inp">
      <option value="0">Sonntag</option><option value="1">Montag</option><option value="2">Dienstag</option><option value="3">Mittwoch</option><option value="4">Donnerstag</option><option value="5">Freitag</option><option value="6">Samstag</option>
    </select>
    <button id="saveWeekBtn" class="btnPrimary w-full">Speichern</button>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="hidden space-y-6">
    <div class="grid md:grid-cols-3 gap-4">
      <div class="card"><h3 class="cardTitle">Aktuelles Gewicht</h3><p id="statCurrentWeight" class="text-3xl font-bold">– kg</p></div>
      <div class="card"><h3 class="cardTitle">Ø kg/Woche nötig</h3><p id="statAvgWeekly" class="text-3xl font-bold">– kg</p></div>
      <div class="card"><h3 class="cardTitle">Punkte</h3><p id="statPoints" class="text-3xl font-bold">0</p></div>
    </div>

    <!-- Journal & Habits -->
    <div class="grid lg:grid-cols-2 gap-6">
      <div class="card"><h3 class="cardTitle"><i data-lucide="book-open"></i> Journal‑Eintrag</h3><textarea id="journalText" rows="4" class="inp" placeholder="Wie lief dein Tag?"></textarea><button id="saveJournalBtn" class="btnPrimary w-full mt-2">Speichern</button></div>
      <div class="card"><h3 class="cardTitle"><i data-lucide="check-circle"></i> Habits</h3><div class="flex gap-2 mb-2"><input id="habitName" class="inp" placeholder="Neuer Habit"/><input id="habitFreq" type="number" min="1" max="7" class="inp w-20" placeholder="x/Woche"/></div><button id="addHabitBtn" class="btnSecondary w-full mb-2">Hinzufügen</button><div id="habitList" class="space-y-2"></div></div>
    </div>

    <!-- Measurements -->
    <div class="card space-y-3"><h3 class="cardTitle"><i data-lucide="ruler"></i> Körpermaße</h3><div class="grid md:grid-cols-6 gap-2"><input id="mWeight" type="number" step="0.1" class="inp" placeholder="Gewicht"/><input id="mWaist" type="number" step="0.1" class="inp" placeholder="Bauch"/><input id="mThigh" type="number" step="0.1" class="inp" placeholder="Oberschenkel"/><input id="mCalf" type="number" step="0.1" class="inp" placeholder="Unterschenkel"/><input id="mChest" type="number" step="0.1" class="inp" placeholder="Brust"/><button id="saveMeasureBtn" class="btnPrimary">Speichern</button></div></div>
  </section>

  <!-- DAILY LOG -->
  <section id="daily" class="hidden space-y-6"><h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="calendar"></i> Tägliche Übersicht</h2><div class="card"><canvas id="pointsChart"></canvas></div><div id="dailyContainer" class="space-y-4"></div></section>

  <!-- SUMMARY -->
  <section id="summary" class="hidden space-y-6"><h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="bar-chart-3"></i> Gesamtübersicht</h2><div class="grid md:grid-cols-3 gap-4" id="summaryContainer"></div><div class="card"><canvas id="weightChart"></canvas></div></section>
</div>

<script>
'use strict';
/************** UTILITIES **************/
const PROFILE_KEY="wlt_profile";
const $=id=>document.getElementById(id);
const loadProfile=()=>JSON.parse(localStorage.getItem(PROFILE_KEY)||"null");
const saveProfile=p=>localStorage.setItem(PROFILE_KEY,JSON.stringify(p));
const today=()=>new Date().toISOString().slice(0,10);
const toDate=s=>new Date(s+"T00:00:00");

let profile=loadProfile();
let selectedDate=today();
let weightChart,pointsChart;

/************** WEEK HELPERS **************/
const weekStart=()=>profile.weekStart??1; // fallback Montag
const startOfWeek=d=>{const date=toDate(d);const diff=(date.getDay()-weekStart()+7)%7;date.setDate(date.getDate()-diff);return date.toISOString().slice(0,10);} ;
const endOfWeek=d=>{const s=startOfWeek(d);const dt=toDate(s);dt.setDate(dt.getDate()+6);return dt.toISOString().slice(0,10);} ;

/************** DOM READY **************/
window.addEventListener('DOMContentLoaded',()=>{
  $("setupBtn").addEventListener('click',onSaveSetup);
  if(profile){initApp();}
});

/************** SETUP  **************/
function onSaveSetup(){
  const start=$("setupStart").value,end=$("setupEnd").value,startW=parseFloat($("setupStartWeight").value),goalW=parseFloat($("setupGoalWeight").value),ws=parseInt($("setupWeekStart").value);
  if(!start||!end||!startW||!goalW)return alert("Bitte alle Felder ausfüllen");
  profile={start,end,startWeight:startW,goalWeight:goalW,weekStart:ws,habits:[],journal:{},measurements:[],points:0,pointsLog:{},habitLog:{}};
  saveProfile(profile);
  $("setupSection").remove();
  initApp();
}

/************** APP INIT **************/
function initApp(){
  const nav=$("mainNav");if(nav)nav.classList.remove("hidden");
  $("entryDate").value=selectedDate;
  $("weekStartSelect").value=weekStart();
  $("entryDate").addEventListener('change',e=>{selectedDate=e.target.value;renderPerDate();});
  document.querySelectorAll('.navBtn').forEach(b=>b.addEventListener('click',e=>showSection(e.currentTarget.dataset.sec)));
  $("openSettings").addEventListener('click',()=>$("settingsPanel").classList.toggle('hidden'));
  $("saveWeekBtn").addEventListener('click',()=>{profile.weekStart=parseInt($("weekStartSelect").value);saveProfile(profile);$("settingsPanel").classList.add('hidden');drawHabitList();drawSummary();});
  $("saveJournalBtn").addEventListener('click',saveJournal);
  $("addHabitBtn").addEventListener('click',addHabit);
  $("saveMeasureBtn").addEventListener('click',saveMeasurement);
  lucide.createIcons();
  showSection('dashboard');
  renderAll();
}

/************** SECTION HANDLING **************/
function showSection(id){['dashboard','daily','summary'].forEach(sec=>$(sec)?.classList.add('hidden'));$(id)?.classList.remove('hidden');if(id==='daily')drawPointsChart();if(id==='summary')drawWeightChart();}

/************** RENDER **************/
function renderAll(){updateStats();drawHabitList();renderPerDate();drawWeightChart();drawPointsChart();drawSummary();}
function renderPerDate(){loadJournal();drawHabitList();updateStats();drawDaily();}

/************** STATS **************/
function updateStats(){const last=profile.measurements.at(-1);const cw=last?last.weight:profile.startWeight;$("statCurrentWeight").textContent=cw.toFixed(1)+' kg';const weeksDiff=(toDate(profile.end)-toDate(profile.start))/(1000*60*60*24*7);$("statAvgWeekly").textContent=((profile.startWeight-profile.goalWeight)/weeksDiff).toFixed(2)+' kg';$("statPoints").textContent=profile.points;saveProfile(profile);} ;

/************** JOURNAL **************/
function loadJournal(){$("journalText").value=profile.journal[selectedDate]||'';} ;
function saveJournal(){const txt=$("journalText").value.trim();if(!txt)return alert('Bitte zuerst Text eingeben');profile.journal[selectedDate]=txt;profile.pointsLog[selectedDate]=profile.pointsLog[selectedDate]||0;saveProfile(profile);drawDaily();alert('Journal gespeichert');}

/************** HABITS **************/
function addHabit(){const name=$("habitName").value.trim(),freq=parseInt($("habitFreq").value);if(!name||!freq)return alert('Felder ausfüllen');profile.habits.push({name,freq});saveProfile(profile);$("habitName").value=$("habitFreq").value='';drawHabitList();drawSummary();}
function doneThisWeek(h){const s=startOfWeek(selectedDate),e=endOfWeek(selectedDate);let n=0;for(const [d,arr] of Object.entries(profile.habitLog)){if(d>=s&&d<=e&&arr.includes(h))n++;}return n;}
function markHabit(i){const h=profile.habits[i];if(doneThisWeek(h.name)>=h.freq)return;const log=profile.habitLog[selectedDate]=profile.habitLog[selectedDate]||[];if(log.includes(h.name))return;log.push(h.name);profile.points++;profile.pointsLog[selectedDate]=(profile.pointsLog[selectedDate]||0)+1;saveProfile(profile);drawHabitList();drawDaily();updateStats();drawSummary();}
function drawHabitList(){const wrap=$("habitList");wrap.innerHTML='';profile.habits.forEach((h,i)=>{const dw=doneThisWeek(h.name),dt=profile.habitLog[selectedDate]?.includes(h.name);const dis=dt||dw>=h.freq;const div=document.createElement('div');div.className='flex justify-between items-center bg-gray-50 rounded p-2';div.innerHTML=`<span>${h.name} (${dw}/${h.freq})</span><button class='${dis?'btnDisabled':'bg-emerald-500 text-white px-2 py-1 rounded'}' ${dis?'disabled':''} onclick='markHabit(${i})'><i data-lucide='${dt?'check':'circle'}'></i></button>`;wrap.appendChild(div);});lucide.createIcons();}

/************** MEASUREMENTS **************/
function saveMeasurement(){const w=parseFloat($("mWeight").value);if(!w)return alert('Gewicht eingeben');const m={date:selectedDate,weight:w,waist:parseFloat($("mWaist").value)||null,thigh:parseFloat($("mThigh").value)||null,calf:parseFloat($("mCalf").value)||null,chest:parseFloat($("mChest").value)||null};profile.measurements.push(m);const prev=profile.measurements.at(-2);if(prev){const kg=prev.weight-w;const cm=(prev.waist||0)-(m.waist||prev.waist||0);const pts=Math.max(0,kg*5)+Math.max(0,cm*2);profile.points+=pts;profile.pointsLog[selectedDate]=(profile.pointsLog[selectedDate]||0)+pts;}saveProfile(profile);['mWeight','mWaist','mThigh','mCalf','mChest'].forEach(id=>$(id).value='');updateStats();drawDaily();drawWeightChart();drawSummary();alert('Maße gespeichert');}

/************** DAILY & SUMMARY **************/
function drawDaily(){const all=new Set([...Object.keys(profile.journal),...Object.keys(profile.habitLog),...profile.measurements.map(m=>m.date)]);const list=[...all].sort((a,b)=>b.localeCompare(a));const cont=$("dailyContainer");cont.innerHTML='';list.forEach(d=>{const j=profile.journal[d]||'-',hs=profile.habitLog[d]?.join(', ')||'-',m=profile.measurements.find(x=>x.date===d),w=m?m.weight+' kg':'-',p=profile.pointsLog[d]||0;const c=document.createElement('div');c.className='card space-y-1';c.innerHTML=`<div class='flex justify-between items-center'><h4 class='font-semibold'>${d}</h4><span class='font-bold'>${p} ★</span></div><p><i data-lucide='book'></i> ${j}</p><p><i data-lucide='check-square'></i> ${hs}</p><p><i data-lucide='scales'></i> ${w}</p>`;cont.appendChild(c);});lucide.createIcons();}
function drawSummary(){const cont=$("summaryContainer");cont.innerHTML='';const weeks=Math.max(1,(toDate(selectedDate)-toDate(profile.start))/(1000*60*60*24*7));const curr=profile.measurements.at(-1)?.weight||profile.startWeight;const lost=profile.startWeight-curr;const prog=((lost)/(profile.startWeight-profile.goalWeight)*100).toFixed(0);const avg=(profile.points/weeks).toFixed(1);const hw=profile.habits.reduce((a,h)=>a+doneThisWeek(h.name),0);const exp=profile.habits.reduce((a,h)=>a+h.freq,0)||1;const hp=Math.min(100,(hw/exp*100)).toFixed(0);const items=[{i:'activity',t:'Gewichtsverlust',v:`${lost.toFixed(1)} kg`},{i:'target',t:'Fortschritt',v:`${prog}%`},{i:'star',t:'Punkte',v:profile.points},{i:'award',t:'Ø Punkte/Woche',v:avg},{i:'check-circle',t:'Habits diese Woche',v:`${hp}%`}];items.forEach(c=>{const d=document.createElement('div');d.className='card';d.innerHTML=`<div class='flex items-center gap-2 mb-1'><i data-lucide='${c.i}'></i><span class='font-semibold'>${c.t}</span></div><p class='text-2xl font-bold'>${c.v}</p>`;cont.appendChild(d);});lucide.createIcons();}

/************** CHARTS **************/
function drawWeightChart(){const ctx=$("weightChart");if(!ctx)return;if(weightChart)weightChart.destroy();if(profile.measurements.length===0){ctx.getContext('2d').clearRect(0,0,ctx.width,ctx.height);return;}weightChart=new Chart(ctx,{type:'line',data:{labels:profile.measurements.map(m=>m.date),datasets:[{label:'Gewicht (kg)',data:profile.measurements.map(m=>m.weight),borderWidth:2,fill:false}]},options:{responsive:true,plugins:{legend:{display:false}}}});} 
function drawPointsChart(){const ctx=$("points
