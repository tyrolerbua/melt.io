/*
  Gewichts‑Tracker‑App
  --------------------
  Innovative, einseitige React‑Anwendung (SPA), die komplett im Browser läuft und
  LocalStorage nutzt, um Daten dauerhaft zu sichern.  
  Benötigte Abhängigkeiten (über z. B. Vite + Tailwind + shadcn/ui):
    - react, react-dom
    - tailwindcss
    - @radix-ui/react-icons  (optional für Icons)
    - recharts               (für Diagramme)
    - shadcn/ui              (Card, Button, Input, Textarea, Tabs)

  Hinweise:
    * Alle Beschriftungen sind Deutsch.
    * Datenstruktur wird automatisch migriert, falls neue Felder hinzukommen.
    * Die App besteht aus drei "Masken": Dashboard, Eingabe, Einstellungen.
*/

import React, { useEffect, useMemo, useState } from "react";
import {
  Card,
  CardHeader,
  CardTitle,
  CardContent,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
} from "recharts";

const STORAGE_KEY = "gewichtstracker_v1";

// ────────────────────────────────────────────────────────────────────────────────
// Hilfsfunktionen
// ────────────────────────────────────────────────────────────────────────────────
const loadState = () => {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch (e) {
    console.error("Fehler beim Laden von LocalStorage", e);
    return null;
  }
};

const saveState = (state) => {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.error("Fehler beim Speichern in LocalStorage", e);
  }
};

const getISODate = (d = new Date()) => d.toISOString().substring(0, 10);

const weeksBetween = (start, end) => {
  const ms = new Date(end) - new Date(start);
  return ms / (1000 * 60 * 60 * 24 * 7);
};

// ────────────────────────────────────────────────────────────────────────────────
// Haupt‑App
// ────────────────────────────────────────────────────────────────────────────────
export default function App() {
  // ───────── State
  const [view, setView] = useState("dashboard");
  const [state, setState] = useState(() =>
    loadState() || {
      settings: {
        startDate: getISODate(),
        targetDate: getISODate(),
        startWeight: 0,
        targetWeight: 0,
        habits: [], // { id, name, perWeek }
      },
      weights: [], // { date, weight }
      habitLogs: [], // { date, habitId }
      diary: [], // { date, text }
    }
  );

  // ───────── Persistenz
  useEffect(() => {
    saveState(state);
  }, [state]);

  // ───────── Abgeleitete Werte
  const currentWeight = useMemo(() => {
    if (state.weights.length === 0) return 0;
    return state.weights[state.weights.length - 1].weight;
  }, [state.weights]);

  const weightProgressPct = useMemo(() => {
    const { startWeight, targetWeight } = state.settings;
    if (!startWeight || !targetWeight) return 0;
    return (
      ((startWeight - currentWeight) / (startWeight - targetWeight)) * 100
    ).toFixed(1);
  }, [state.settings, currentWeight]);

  const avgWeeklyLoss = useMemo(() => {
    const { startDate } = state.settings;
    if (state.weights.length < 2) return 0;
    const weeks = weeksBetween(startDate, new Date());
    if (weeks <= 0) return 0;
    const loss = state.settings.startWeight - currentWeight;
    return (loss / weeks).toFixed(2);
  }, [state, currentWeight]);

  const habitCompletion = useMemo(() => {
    const map = {};
    state.settings.habits.forEach((h) => {
      map[h.id] = { ...h, done: 0 };
    });
    state.habitLogs.forEach((log) => {
      if (map[log.habitId]) map[log.habitId].done += 1;
    });
    return map;
  }, [state]);

  // ───────── Handler
  const addOrUpdateWeight = (date, weight) => {
    setState((s) => {
      const existingIdx = s.weights.findIndex((w) => w.date === date);
      const weights = [...s.weights];
      if (existingIdx >= 0) {
        weights[existingIdx].weight = weight;
      } else {
        weights.push({ date, weight });
        weights.sort((a, b) => a.date.localeCompare(b.date));
      }
      return { ...s, weights };
    });
  };

  const addHabitLog = (date, habitIds) => {
    setState((s) => {
      // entferne alte Logs für den Tag
      const others = s.habitLogs.filter((l) => l.date !== date);
      const newLogs = habitIds.map((id) => ({ date, habitId: id }));
      return { ...s, habitLogs: [...others, ...newLogs] };
    });
  };

  const saveDiary = (date, text) => {
    setState((s) => {
      const idx = s.diary.findIndex((d) => d.date === date);
      const diary = [...s.diary];
      if (idx >= 0) diary[idx].text = text;
      else diary.push({ date, text });
      diary.sort((a, b) => b.date.localeCompare(a.date));
      return { ...s, diary };
    });
  };

  const updateSettings = (newSettings) => {
    setState((s) => ({ ...s, settings: { ...s.settings, ...newSettings } }));
  };

  // ───────── Komponenten‑Auswahl
  const renderView = () => {
    switch (view) {
      case "eingabe":
        return (
          <InputMask
            state={state}
            addOrUpdateWeight={addOrUpdateWeight}
            addHabitLog={addHabitLog}
            saveDiary={saveDiary}
          />
        );
      case "einstellungen":
        return <Settings state={state} updateSettings={updateSettings} />;
      default:
        return <Dashboard state={state} weightProgressPct={weightProgressPct} avgWeeklyLoss={avgWeeklyLoss} habitCompletion={habitCompletion} />;
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 text-gray-800">
      <header className="bg-white shadow sticky top-0 z-10">
        <nav className="container mx-auto flex justify-between p-4">
          <h1 className="text-xl font-bold">Gewichts‑Tracker</h1>
          <div className="space-x-4">
            <Button variant={view === "dashboard" ? "default" : "ghost"} onClick={() => setView("dashboard")}>Dashboard</Button>
            <Button variant={view === "eingabe" ? "default" : "ghost"} onClick={() => setView("eingabe")}>Eingabe</Button>
            <Button variant={view === "einstellungen" ? "default" : "ghost"} onClick={() => setView("einstellungen")}>Einstellungen</Button>
          </div>
        </nav>
      </header>
      <main className="container mx-auto p-4">{renderView()}</main>
    </div>
  );
}

// ────────────────────────────────────────────────────────────────────────────────
// Dashboard
// ────────────────────────────────────────────────────────────────────────────────
function Dashboard({ state, weightProgressPct, avgWeeklyLoss, habitCompletion }) {
  const { settings, weights, diary } = state;
  const currentWeight = weights.length ? weights[weights.length - 1].weight : 0;

  return (
    <div className="grid gap-6 lg:grid-cols-3">
      {/* Übersichtskarten */}
      <Card className="lg:col-span-3">
        <CardHeader>
          <CardTitle>Fastenzeitraum</CardTitle>
        </CardHeader>
        <CardContent className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
          <div>
            <p className="text-sm text-gray-500">Start</p>
            <p className="text-lg font-semibold">{settings.startDate}</p>
          </div>
          <div>
            <p className="text-sm text-gray-500">Ziel</p>
            <p className="text-lg font-semibold">{settings.targetDate}</p>
          </div>
          <div>
            <p className="text-sm text-gray-500">Startgewicht</p>
            <p className="text-lg font-semibold">{settings.startWeight} kg</p>
          </div>
          <div>
            <p className="text-sm text-gray-500">Zielgewicht</p>
            <p className="text-lg font-semibold">{settings.targetWeight} kg</p>
          </div>
        </CardContent>
      </Card>
      <Card>
        <CardHeader>
          <CardTitle>Aktuelles Gewicht</CardTitle>
        </CardHeader>
        <CardContent className="text-center text-3xl font-bold">
          {currentWeight ? `${currentWeight} kg` : "–"}
        </CardContent>
      </Card>
      <Card>
        <CardHeader>
          <CardTitle>Fortschritt</CardTitle>
        </CardHeader>
        <CardContent className="text-center">
          <p className="text-5xl font-bold">{weightProgressPct}%</p>
          <p className="text-sm text-gray-500 mt-1">vom Ziel erreicht</p>
        </CardContent>
      </Card>
      <Card>
        <CardHeader>
          <CardTitle>Ø Gewichtsverlust / Woche</CardTitle>
        </CardHeader>
        <CardContent className="text-center text-3xl font-bold">
          {avgWeeklyLoss} kg
        </CardContent>
      </Card>

      {/* Gewichtsverlauf */}
      <Card className="lg:col-span-3">
        <CardHeader>
          <CardTitle>Gewichtsverlauf</CardTitle>
        </CardHeader>
        <CardContent>
          {weights.length ? (
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={weights} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="date" />
                <YAxis domain={["dataMin - 2", "dataMax + 2"]} />
                <Tooltip formatter={(v) => `${v} kg`} />
                <Line type="monotone" dataKey="weight" strokeWidth={3} dot={false} />
              </LineChart>
            </ResponsiveContainer>
          ) : (
            <p className="text-center text-gray-500">Noch keine Gewichts‑Einträge.</p>
          )}
        </CardContent>
      </Card>

      {/* Habit‑Auswertung */}
      <Card className="lg:col-span-2">
        <CardHeader>
          <CardTitle>Gewohnheiten</CardTitle>
        </CardHeader>
        <CardContent>
          {state.settings.habits.length ? (
            <ul className="space-y-2">
              {Object.values(habitCompletion).map((h) => (
                <li key={h.id} className="flex justify-between">
                  <span>{h.name}</span>
                  <span>
                    {h.done}/{h.perWeek * weeksBetween(state.settings.startDate, new Date()) | 0}
                  </span>
                </li>
              ))}
            </ul>
          ) : (
            <p className="text-gray-500">Keine Gewohnheiten definiert.</p>
          )}
        </CardContent>
      </Card>

      {/* Tagebuch Übersicht */}
      <Card>
        <CardHeader>
          <CardTitle>Tagebuch</CardTitle>
        </CardHeader>
        <CardContent className="space-y-2 max-h-72 overflow-y-auto">
          {diary.length ? (
            diary.map((d) => (
              <div key={d.date}>
                <p className="text-sm font-semibold">{d.date}</p>
                <p className="text-sm text-gray-700 line-clamp-2">{d.text}</p>
              </div>
            ))
          ) : (
            <p className="text-gray-500">Keine Einträge.</p>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

// ────────────────────────────────────────────────────────────────────────────────
// Eingabe‑Maske
// ────────────────────────────────────────────────────────────────────────────────
function InputMask({ state, addOrUpdateWeight, addHabitLog, saveDiary }) {
  const today = getISODate();
  const [date, setDate] = useState(today);
  const [weight, setWeight] = useState("");
  const [selectedHabits, setSelectedHabits] = useState([]);
  const [text, setText] = useState("");

  useEffect(() => {
    // Lade bestehende Daten für das Datum
    const w = state.weights.find((w) => w.date === date);
    setWeight(w ? w.weight : "");
    const logs = state.habitLogs.filter((l) => l.date === date).map((l) => l.habitId);
    setSelectedHabits(logs);
    const d = state.diary.find((d) => d.date === date);
    setText(d ? d.text : "");
  }, [date, state]);

  const toggleHabit = (id) => {
    setSelectedHabits((s) => (s.includes(id) ? s.filter((x) => x !== id) : [...s, id]));
  };

  const handleSave = () => {
    if (weight) addOrUpdateWeight(date, parseFloat(weight));
    addHabitLog(date, selectedHabits);
    if (text.trim()) saveDiary(date, text.trim());
    alert("Eintrag gespeichert!");
  };

  return (
    <Card className="max-w-xl mx-auto">
      <CardHeader>
        <CardTitle>Neuer Tages‑Eintrag</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="space-y-1">
          <label className="block text-sm font-medium">Datum</label>
          <Input type="date" value={date} onChange={(e) => setDate(e.target.value)} />
        </div>
        <div className="space-y-1">
          <label className="block text-sm font-medium">Gewicht (kg)</label>
          <Input type="number" step="0.1" min="0" value={weight} onChange={(e) => setWeight(e.target.value)} />
        </div>
        <div className="space-y-1">
          <p className="text-sm font-medium">Gewohnheiten</p>
          <div className="flex flex-wrap gap-2">
            {state.settings.habits.map((h) => (
              <Button
                key={h.id}
                variant={selectedHabits.includes(h.id) ? "default" : "outline"}
                onClick={() => toggleHabit(h.id)}
              >
                {h.name}
              </Button>
            ))}
          </div>
        </div>
        <div className="space-y-1">
          <label className="block text-sm font-medium">Tagebuch</label>
          <Textarea rows={5} value={text} onChange={(e) => setText(e.target.value)} />
        </div>
        <Button className="w-full" onClick={handleSave}>
          Speichern
        </Button>
      </CardContent>
    </Card>
  );
}

// ────────────────────────────────────────────────────────────────────────────────
// Einstellungen
// ────────────────────────────────────────────────────────────────────────────────
function Settings({ state, updateSettings }) {
  const s = state.settings;
  const [local, setLocal] = useState(s);
  const [newHabitName, setNewHabitName] = useState("");
  const [newHabitPerWeek, setNewHabitPerWeek] = useState(3);

  const handleSave = () => {
    updateSettings(local);
    alert("Einstellungen gespeichert!");
  };

  const addHabit = () => {
    if (!newHabitName.trim()) return;
    setLocal((l) => ({
      ...l,
      habits: [
        ...l.habits,
        {
          id: Date.now().toString(36),
          name: newHabitName.trim(),
          perWeek: newHabitPerWeek,
        },
      ],
    }));
    setNewHabitName("");
  };

  const deleteHabit = (id) => {
    setLocal((l) => ({ ...l, habits: l.habits.filter((h) => h.id !== id) }));
  };

  return (
    <div className="max-w-2xl mx-auto space-y-6">
      <Card>
        <CardHeader>
          <CardTitle>Gewicht & Zeitraum</CardTitle>
        </CardHeader>
        <CardContent className="grid md:grid-cols-2 gap-4">
          <div className="space-y-1">
            <label className="text-sm font-medium">Startgewicht (kg)</label>
            <Input type="number" step="0.1" value={local.startWeight} onChange={(e) => setLocal({ ...local, startWeight: parseFloat(e.target.value) })} />
          </div>
          <div className="space-y-1">
            <label className="text-sm font-medium">Zielgewicht (kg)</label>
            <Input type="number" step="0.1" value={local.targetWeight} onChange={(e) => setLocal({ ...local, targetWeight: parseFloat(e.target.value) })} />
          </div>
          <div className="space-y-1">
            <label className="text-sm font-medium">Fasten‑Start</label>
            <Input type="date" value={local.startDate} onChange={(e) => setLocal({ ...local, startDate: e.target.value })} />
          </div>
          <div className="space-y-1">
            <label className="text-sm font-medium">Fasten‑Ende</label>
            <Input type="date" value={local.targetDate} onChange={(e) => setLocal({ ...local, targetDate: e.target.value })} />
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Gewohnheiten</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex gap-2">
            <Input placeholder="Neue Gewohnheit" value={newHabitName} onChange={(e) => setNewHabitName(e.target.value)} />
            <Input type="number" min="1" max="7" className="w-20" value={newHabitPerWeek} onChange={(e) => setNewHabitPerWeek(parseInt(e.target.value) || 1)} />
            <Button onClick={addHabit}>Hinzufügen</Button>
          </div>
          <ul className="space-y-2">
            {local.habits.map((h) => (
              <li key={h.id} className="flex justify-between items-center p-2 bg-gray-100 rounded-md">
                <span>{h.name} ({h.perWeek}×/Woche)</span>
                <Button size="sm" variant="destructive" onClick={() => deleteHabit(h.id)}>
                  Entfernen
                </Button>
              </li>
            ))}
          </ul>
        </CardContent>
      </Card>

      <Button className="w-full" size="lg" onClick={handleSave}>
        Einstellungen speichern
      </Button>
    </div>
  );
}
